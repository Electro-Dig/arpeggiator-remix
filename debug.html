<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arpeggiator Debug - åˆå§‹åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .debug-panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .status.success {
            background: #2d5a3d;
            border: 1px solid #4caf50;
        }
        .status.error {
            background: #5a2d2d;
            border: 1px solid #f44336;
        }
        .status.warning {
            background: #5a4d2d;
            border: 1px solid #ff9800;
        }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5855eb;
        }
    </style>
</head>
<body>
    <h1>ğŸµ Arpeggiator-Remix è°ƒè¯•é¢æ¿</h1>
    
    <div class="debug-panel">
        <h2>ğŸ”§ åˆå§‹åŒ–çŠ¶æ€æ£€æŸ¥</h2>
        <div id="init-status">æ£€æŸ¥ä¸­...</div>
        <button class="test-button" onclick="checkInitialization()">é‡æ–°æ£€æŸ¥</button>
        <button class="test-button" onclick="testAudioPermissions()">æµ‹è¯•éŸ³é¢‘æƒé™</button>
        <button class="test-button" onclick="testCameraPermissions()">æµ‹è¯•æ‘„åƒå¤´æƒé™</button>
    </div>

    <div class="debug-panel">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
        <div id="system-status">
            <div class="status" id="tone-status">Tone.js: æœªæ£€æµ‹</div>
            <div class="status" id="mediapipe-status">MediaPipe: æœªæ£€æµ‹</div>
            <div class="status" id="threejs-status">Three.js: æœªæ£€æµ‹</div>
            <div class="status" id="managers-status">ç®¡ç†å™¨: æœªæ£€æµ‹</div>
        </div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ› æ‰‹åŠ¨æµ‹è¯•</h2>
        <button class="test-button" onclick="testMusicManager()">æµ‹è¯•éŸ³ä¹ç®¡ç†å™¨</button>
        <button class="test-button" onclick="testDrumManager()">æµ‹è¯•é¼“æœºç®¡ç†å™¨</button>
        <button class="test-button" onclick="startApp()">å¯åŠ¨åº”ç”¨</button>
    </div>

    <div class="debug-panel">
        <h2>ğŸ“ æ—¥å¿—è¾“å‡º</h2>
        <div id="log-output" style="background: #000; padding: 10px; border-radius: 4px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px;"></div>
        <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script type="module">
        import { Game } from './game.js';
        import { MusicManager } from './MusicManager.js';
        import * as DrumManager from './DrumManager.js';

        // æ—¥å¿—æ•è·
        const logOutput = document.getElementById('log-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function logToPanel(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#51cf66';
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPanel(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToPanel('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToPanel('WARN: ' + args.join(' '), 'warn');
        };

        window.checkInitialization = function() {
            console.log('å¼€å§‹æ£€æŸ¥ç³»ç»Ÿåˆå§‹åŒ–çŠ¶æ€...');
            
            // æ£€æŸ¥ Tone.js
            if (typeof Tone !== 'undefined') {
                document.getElementById('tone-status').className = 'status success';
                document.getElementById('tone-status').textContent = 'Tone.js: âœ… å·²åŠ è½½';
            } else {
                document.getElementById('tone-status').className = 'status error';
                document.getElementById('tone-status').textContent = 'Tone.js: âŒ æœªåŠ è½½';
            }

            // æ£€æŸ¥ Three.js
            if (typeof THREE !== 'undefined') {
                document.getElementById('threejs-status').className = 'status success';
                document.getElementById('threejs-status').textContent = 'Three.js: âœ… å·²åŠ è½½';
            } else {
                document.getElementById('threejs-status').className = 'status error';
                document.getElementById('threejs-status').textContent = 'Three.js: âŒ æœªåŠ è½½';
            }

            // æ£€æŸ¥ç®¡ç†å™¨
            try {
                const musicManager = new MusicManager();
                const hasPresets = musicManager.musicPresets && musicManager.musicPresets.length > 0;
                
                if (hasPresets) {
                    document.getElementById('managers-status').className = 'status success';
                    document.getElementById('managers-status').textContent = `ç®¡ç†å™¨: âœ… éŸ³ä¹é¢„è®¾(${musicManager.musicPresets.length}ä¸ª)`;
                } else {
                    document.getElementById('managers-status').className = 'status warning';
                    document.getElementById('managers-status').textContent = 'ç®¡ç†å™¨: âš ï¸ é¢„è®¾æ•°æ®ç¼ºå¤±';
                }
            } catch (error) {
                document.getElementById('managers-status').className = 'status error';
                document.getElementById('managers-status').textContent = 'ç®¡ç†å™¨: âŒ åˆå§‹åŒ–å¤±è´¥';
                console.error('ç®¡ç†å™¨åˆå§‹åŒ–é”™è¯¯:', error);
            }
        };

        window.testAudioPermissions = async function() {
            try {
                console.log('è¯·æ±‚éŸ³é¢‘æƒé™...');
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('âœ… éŸ³é¢‘æƒé™å·²è·å–');
            } catch (error) {
                console.error('âŒ éŸ³é¢‘æƒé™è·å–å¤±è´¥:', error);
            }
        };

        window.testCameraPermissions = async function() {
            try {
                console.log('è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                console.log('âœ… æ‘„åƒå¤´æƒé™å·²è·å–');
                stream.getTracks().forEach(track => track.stop()); // åœæ­¢æµ
            } catch (error) {
                console.error('âŒ æ‘„åƒå¤´æƒé™è·å–å¤±è´¥:', error);
            }
        };

        window.testMusicManager = function() {
            try {
                console.log('æµ‹è¯•éŸ³ä¹ç®¡ç†å™¨...');
                const manager = new MusicManager();
                console.log('âœ… MusicManager åˆ›å»ºæˆåŠŸ');
                console.log('é¢„è®¾æ•°é‡:', manager.musicPresets?.length || 0);
                if (manager.musicPresets && manager.musicPresets.length > 0) {
                    console.log('ç¬¬ä¸€ä¸ªé¢„è®¾:', manager.musicPresets[0].name);
                }
            } catch (error) {
                console.error('âŒ MusicManager æµ‹è¯•å¤±è´¥:', error);
            }
        };

        window.testDrumManager = function() {
            try {
                console.log('æµ‹è¯•é¼“æœºç®¡ç†å™¨...');
                const presets = DrumManager.getAllDrumPresets();
                console.log('âœ… DrumManager è®¿é—®æˆåŠŸ');
                console.log('é¼“ç»„é¢„è®¾æ•°é‡:', presets?.length || 0);
                if (presets && presets.length > 0) {
                    console.log('ç¬¬ä¸€ä¸ªé¢„è®¾:', presets[0].name);
                }
            } catch (error) {
                console.error('âŒ DrumManager æµ‹è¯•å¤±è´¥:', error);
            }
        };

        window.startApp = function() {
            console.log('å°è¯•å¯åŠ¨åº”ç”¨...');
            const renderDiv = document.getElementById('app-container');
            if (!renderDiv) {
                const newDiv = document.createElement('div');
                newDiv.id = 'app-container';
                newDiv.style.cssText = 'width: 100%; height: 400px; background: #000; margin-top: 20px;';
                document.body.appendChild(newDiv);
                
                try {
                    const game = new Game(newDiv);
                    console.log('âœ… æ¸¸æˆå®ä¾‹åˆ›å»ºæˆåŠŸ');
                } catch (error) {
                    console.error('âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                }
            }
        };

        window.clearLog = function() {
            logOutput.innerHTML = '';
        };

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        setTimeout(checkInitialization, 1000);
    </script>
</body>
</html> 