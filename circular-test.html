<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圆形音序器测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        h1 {
            color: #7B4394;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(123, 67, 148, 0.5);
        }
        
        .test-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #7B4394, #9B59B6);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #9B59B6, #BB79D6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(123, 67, 148, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        #circular-sequencer-test {
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .info {
            background: rgba(123, 67, 148, 0.1);
            border: 1px solid rgba(123, 67, 148, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }
        
        .info h3 {
            color: #7B4394;
            margin-top: 0;
        }
        
        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 圆形音序器测试</h1>
        
        <div class="info">
            <h3>使用说明：</h3>
            <ul>
                <li>点击圆环上的段来激活/取消激活节拍</li>
                <li>从外到内分别是：Kick、Snare、Hi-hat、Clap、Open Hat</li>
                <li>每个环有16个段，对应16拍音序</li>
                <li>支持鼠标拖拽来快速设置多个节拍</li>
                <li>使用下方按钮测试各种功能</li>
            </ul>
        </div>
        
        <div class="test-container">
            <div class="controls">
                <button class="btn" onclick="createSequencer()">创建音序器</button>
                <button class="btn" onclick="clearAll()">清空所有</button>
                <button class="btn" onclick="randomize()">随机化</button>
                <button class="btn" onclick="testPlayback()">测试播放</button>
                <button class="btn" onclick="getPatterns()">获取模式</button>
                <button class="btn" onclick="destroySequencer()">销毁音序器</button>
            </div>
            
            <div id="circular-sequencer-test"></div>
        </div>
        
        <div id="output" class="info" style="display: none;">
            <h3>输出信息：</h3>
            <pre id="output-content"></pre>
        </div>
    </div>

    <script type="module">
        // 导入CircularSequencer类
        let CircularSequencer;
        let sequencer = null;
        let playInterval = null;
        let currentStep = 0;
        
        // 从CustomEditor.js中提取CircularSequencer类
        async function loadCircularSequencer() {
            try {
                // 动态创建CircularSequencer类
                window.CircularSequencer = class CircularSequencer {
                    constructor(containerId, options = {}) {
                        this.containerId = containerId;
                        this.container = document.getElementById(containerId);
                        
                        // 配置参数
                        this.config = {
                            centerX: options.centerX || 250,
                            centerY: options.centerY || 250,
                            innerRadius: options.innerRadius || 60,
                            ringWidth: options.ringWidth || 35,
                            ringGap: options.ringGap || 3,
                            segments: options.segments || 16,
                            ...options
                        };
                        
                        // 鼓声配置
                        this.drumTypes = [
                            { id: 'kick', name: 'Kick', color: '#D72828', emoji: '🥁' },
                            { id: 'snare', name: 'Snare', color: '#F36E2F', emoji: '🥁' },
                            { id: 'hihat', name: 'Hi-hat', color: '#84C34E', emoji: '🎩' },
                            { id: 'clap', name: 'Clap', color: '#7B4394', emoji: '👏' },
                            { id: 'openhat', name: 'Open Hat', color: '#4A90E2', emoji: '🎩' }
                        ];
                        
                        // 状态数据
                        this.patterns = {};
                        this.drumTypes.forEach(drum => {
                            this.patterns[drum.id] = new Array(16).fill(false);
                        });
                        
                        // Canvas相关
                        this.canvas = null;
                        this.ctx = null;
                        this.animationId = null;
                        this.currentPlayPosition = -1;
                        
                        // 交互状态
                        this.isDragging = false;
                        this.lastClickedSegment = null;
                        
                        this.init();
                    }
                    
                    init() {
                        this.createCanvas();
                        this.createLegend();
                        this.setupEventListeners();
                        this.render();
                        console.log('✅ 圆形音序器已初始化');
                    }
                    
                    createCanvas() {
                        // 创建canvas元素
                        this.canvas = document.createElement('canvas');
                        this.canvas.width = this.config.centerX * 2;
                        this.canvas.height = this.config.centerY * 2;
                        this.canvas.style.border = '1px solid #333';
                        this.canvas.style.borderRadius = '50%';
                        this.canvas.style.background = 'radial-gradient(circle, #1a1a1a 0%, #000 100%)';
                        this.canvas.style.cursor = 'pointer';
                        
                        this.ctx = this.canvas.getContext('2d');
                        
                        // 清空容器并添加canvas
                        this.container.innerHTML = '';
                        this.container.appendChild(this.canvas);
                    }
                    
                    createLegend() {
                        const legend = document.createElement('div');
                        legend.className = 'circular-legend';
                        legend.style.display = 'flex';
                        legend.style.justifyContent = 'center';
                        legend.style.gap = '15px';
                        legend.style.flexWrap = 'wrap';
                        legend.style.marginTop = '10px';
                        
                        this.drumTypes.forEach((drum, index) => {
                            const legendItem = document.createElement('div');
                            legendItem.style.display = 'flex';
                            legendItem.style.alignItems = 'center';
                            legendItem.style.gap = '8px';
                            legendItem.style.padding = '6px 12px';
                            legendItem.style.background = 'rgba(255, 255, 255, 0.1)';
                            legendItem.style.borderRadius = '20px';
                            legendItem.style.fontSize = '12px';
                            legendItem.style.color = 'white';
                            legendItem.style.border = '1px solid rgba(255, 255, 255, 0.2)';
                            
                            const colorDot = document.createElement('div');
                            colorDot.style.width = '12px';
                            colorDot.style.height = '12px';
                            colorDot.style.borderRadius = '50%';
                            colorDot.style.backgroundColor = drum.color;
                            colorDot.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                            
                            const label = document.createElement('span');
                            label.textContent = `${drum.emoji} ${drum.name}`;
                            
                            legendItem.appendChild(colorDot);
                            legendItem.appendChild(label);
                            legend.appendChild(legendItem);
                        });
                        
                        this.container.appendChild(legend);
                    }
                    
                    setupEventListeners() {
                        this.canvas.addEventListener('click', (e) => this.handleClick(e));
                        this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                        this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                        this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                        this.canvas.addEventListener('mouseleave', (e) => this.handleMouseUp(e));
                    }
                    
                    // 获取鼠标在canvas中的坐标
                    getMousePos(e) {
                        const rect = this.canvas.getBoundingClientRect();
                        return {
                            x: e.clientX - rect.left,
                            y: e.clientY - rect.top
                        };
                    }
                    
                    // 将笛卡尔坐标转换为极坐标
                    cartesianToPolar(x, y) {
                        const dx = x - this.config.centerX;
                        const dy = y - this.config.centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        let angle = Math.atan2(dy, dx);
                        
                        // 调整角度，使0度在顶部，顺时针增加
                        angle = angle + Math.PI / 2;
                        if (angle < 0) angle += 2 * Math.PI;
                        
                        return { distance, angle };
                    }
                    
                    // 根据极坐标确定点击的环和段
                    getSegmentFromPolar(distance, angle) {
                        // 确定环（从外到内：0-4）
                        let ring = -1;
                        for (let i = 0; i < this.drumTypes.length; i++) {
                            const innerR = this.config.innerRadius + i * (this.config.ringWidth + this.config.ringGap);
                            const outerR = innerR + this.config.ringWidth;
                            
                            if (distance >= innerR && distance <= outerR) {
                                ring = i;
                                break;
                            }
                        }
                        
                        if (ring === -1) return null;
                        
                        // 确定段（0-15）
                        const segmentAngle = (2 * Math.PI) / this.config.segments;
                        const segment = Math.floor(angle / segmentAngle) % this.config.segments;
                        
                        return { ring, segment };
                    }
                    
                    // 处理鼠标事件
                    handleClick(e) {
                        const mousePos = this.getMousePos(e);
                        const polar = this.cartesianToPolar(mousePos.x, mousePos.y);
                        const segment = this.getSegmentFromPolar(polar.distance, polar.angle);
                        
                        if (segment) {
                            this.toggleSegment(segment.ring, segment.segment);
                        }
                    }
                    
                    handleMouseDown(e) {
                        this.isDragging = true;
                        this.handleClick(e);
                    }
                    
                    handleMouseMove(e) {
                        if (!this.isDragging) return;
                        
                        const mousePos = this.getMousePos(e);
                        const polar = this.cartesianToPolar(mousePos.x, mousePos.y);
                        const segment = this.getSegmentFromPolar(polar.distance, polar.angle);
                        
                        if (segment && this.lastClickedSegment) {
                            const key = `${segment.ring}-${segment.segment}`;
                            const lastKey = `${this.lastClickedSegment.ring}-${this.lastClickedSegment.segment}`;
                            
                            if (key !== lastKey) {
                                this.toggleSegment(segment.ring, segment.segment);
                                this.lastClickedSegment = segment;
                            }
                        }
                    }
                    
                    handleMouseUp(e) {
                        this.isDragging = false;
                        this.lastClickedSegment = null;
                    }
                    
                    // 切换段的激活状态
                    toggleSegment(ring, segment) {
                        if (ring >= 0 && ring < this.drumTypes.length && segment >= 0 && segment < this.config.segments) {
                            const drumType = this.drumTypes[ring].id;
                            this.patterns[drumType][segment] = !this.patterns[drumType][segment];
                            this.lastClickedSegment = { ring, segment };
                            this.render();
                        }
                    }
                    
                    // 渲染圆形音序器
                    render() {
                        const ctx = this.ctx;
                        const { centerX, centerY, innerRadius, ringWidth, ringGap, segments } = this.config;
                        
                        // 清空画布
                        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // 绘制每个环
                        this.drumTypes.forEach((drumType, ringIndex) => {
                            const innerR = innerRadius + ringIndex * (ringWidth + ringGap);
                            const outerR = innerR + ringWidth;
                            
                            // 绘制每个段
                            for (let segmentIndex = 0; segmentIndex < segments; segmentIndex++) {
                                const startAngle = (segmentIndex * 2 * Math.PI / segments) - Math.PI / 2;
                                const endAngle = ((segmentIndex + 1) * 2 * Math.PI / segments) - Math.PI / 2;
                                
                                const isActive = this.patterns[drumType.id][segmentIndex];
                                const isCurrentPlay = segmentIndex === this.currentPlayPosition;
                                
                                // 设置颜色
                                let color = drumType.color;
                                let alpha = isActive ? 0.8 : 0.2;
                                
                                if (isCurrentPlay) {
                                    alpha = Math.min(alpha + 0.3, 1.0);
                                }
                                
                                // 绘制段
                                ctx.beginPath();
                                ctx.arc(centerX, centerY, innerR, startAngle, endAngle);
                                ctx.arc(centerX, centerY, outerR, endAngle, startAngle, true);
                                ctx.closePath();
                                
                                // 填充颜色
                                ctx.fillStyle = this.hexToRgba(color, alpha);
                                ctx.fill();
                                
                                // 绘制边框
                                ctx.strokeStyle = this.hexToRgba('#ffffff', 0.1);
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                
                                // 如果是激活状态，添加发光效果
                                if (isActive) {
                                    ctx.shadowColor = color;
                                    ctx.shadowBlur = 8;
                                    ctx.fill();
                                    ctx.shadowBlur = 0;
                                }
                            }
                        });
                        
                        // 绘制中心标签
                        this.drawCenterLabel();
                        
                        // 绘制播放指针
                        if (this.currentPlayPosition >= 0) {
                            this.drawPlayPointer();
                        }
                    }
                    
                    // 绘制中心标签
                    drawCenterLabel() {
                        const ctx = this.ctx;
                        const { centerX, centerY, innerRadius } = this.config;
                        
                        // 绘制中心圆
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, innerRadius - 5, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.fill();
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // 绘制文字
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('DRUM', centerX, centerY - 8);
                        ctx.font = '12px Arial';
                        ctx.fillText('SEQUENCER', centerX, centerY + 8);
                    }
                    
                    // 绘制播放指针
                    drawPlayPointer() {
                        const ctx = this.ctx;
                        const { centerX, centerY, innerRadius, ringWidth, ringGap } = this.config;
                        const totalRadius = innerRadius + this.drumTypes.length * (ringWidth + ringGap) + 10;
                        
                        const angle = (this.currentPlayPosition * 2 * Math.PI / this.config.segments) - Math.PI / 2;
                        const endX = centerX + Math.cos(angle) * totalRadius;
                        const endY = centerY + Math.sin(angle) * totalRadius;
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.lineTo(endX, endY);
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        // 绘制指针头
                        ctx.beginPath();
                        ctx.arc(endX, endY, 4, 0, 2 * Math.PI);
                        ctx.fillStyle = '#ffffff';
                        ctx.fill();
                    }
                    
                    // 工具方法：将十六进制颜色转换为RGBA
                    hexToRgba(hex, alpha) {
                        const r = parseInt(hex.slice(1, 3), 16);
                        const g = parseInt(hex.slice(3, 5), 16);
                        const b = parseInt(hex.slice(5, 7), 16);
                        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    }
                    
                    // 设置播放位置
                    setPlayPosition(position) {
                        this.currentPlayPosition = position;
                        this.render();
                    }
                    
                    // 获取当前模式
                    getPatterns() {
                        return { ...this.patterns };
                    }
                    
                    // 设置模式
                    setPatterns(patterns) {
                        this.patterns = { ...patterns };
                        this.render();
                    }
                    
                    // 清空所有模式
                    clearAll() {
                        this.drumTypes.forEach(drum => {
                            this.patterns[drum.id] = new Array(16).fill(false);
                        });
                        this.render();
                    }
                    
                    // 随机化模式
                    randomize() {
                        this.drumTypes.forEach(drum => {
                            this.patterns[drum.id] = new Array(16).fill(false).map(() => Math.random() > 0.7);
                        });
                        this.render();
                    }
                    
                    // 销毁
                    destroy() {
                        if (this.animationId) {
                            cancelAnimationFrame(this.animationId);
                        }
                        if (this.container) {
                            this.container.innerHTML = '';
                        }
                    }
                };
                
                console.log('✅ CircularSequencer类已加载');
            } catch (error) {
                console.error('❌ 加载CircularSequencer失败:', error);
            }
        }
        
        // 全局函数
        window.createSequencer = function() {
            if (sequencer) {
                sequencer.destroy();
            }
            
            sequencer = new window.CircularSequencer('circular-sequencer-test', {
                centerX: 200,
                centerY: 200,
                innerRadius: 50,
                ringWidth: 30,
                ringGap: 2,
                segments: 16
            });
            
            showOutput('音序器已创建');
        };
        
        window.clearAll = function() {
            if (sequencer) {
                sequencer.clearAll();
                showOutput('所有模式已清空');
            } else {
                showOutput('请先创建音序器');
            }
        };
        
        window.randomize = function() {
            if (sequencer) {
                sequencer.randomize();
                showOutput('模式已随机化');
            } else {
                showOutput('请先创建音序器');
            }
        };
        
        window.testPlayback = function() {
            if (!sequencer) {
                showOutput('请先创建音序器');
                return;
            }
            
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                sequencer.setPlayPosition(-1);
                showOutput('播放已停止');
                return;
            }
            
            currentStep = 0;
            playInterval = setInterval(() => {
                sequencer.setPlayPosition(currentStep);
                currentStep = (currentStep + 1) % 16;
            }, 200);
            
            showOutput('开始测试播放（每200ms一步）');
        };
        
        window.getPatterns = function() {
            if (sequencer) {
                const patterns = sequencer.getPatterns();
                showOutput('当前模式：\n' + JSON.stringify(patterns, null, 2));
            } else {
                showOutput('请先创建音序器');
            }
        };
        
        window.destroySequencer = function() {
            if (sequencer) {
                if (playInterval) {
                    clearInterval(playInterval);
                    playInterval = null;
                }
                sequencer.destroy();
                sequencer = null;
                showOutput('音序器已销毁');
            } else {
                showOutput('没有音序器需要销毁');
            }
        };
        
        function showOutput(message) {
            const output = document.getElementById('output');
            const content = document.getElementById('output-content');
            content.textContent = message;
            output.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                output.style.display = 'none';
            }, 3000);
        }
        
        // 初始化
        await loadCircularSequencer();
        console.log('🎯 圆形音序器测试页面已加载');
    </script>
</body>
</html>
